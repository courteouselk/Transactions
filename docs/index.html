<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Transactions  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Transactions  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">Transactions Docs</a></p>
        <p class="header-right"><a href="https://github.com/courteouselk/Transactions"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">Transactions Reference</a>
        <img id="carat" src="img/carat.png" />
        Transactions  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/TransactionContext.html">TransactionContext</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/TransactionError.html">TransactionError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/Transactable.html">Transactable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/Transaction.html">Transaction</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='transactions' class='heading'>Transactions</h1>

<p><a href="https://raw.githubusercontent.com/courteouselk/Transactions/master/LICENSE"><img src="https://img.shields.io/github/license/courteouselk/Transactions.svg?maxAge=2592000" alt="License"></a>
<a href="https://developer.apple.com/swift/"><img src="https://img.shields.io/badge/Swift-3.1-E9392C.svg?style=flat" alt="Swift 3.1"></a>
<a href="https://github.com/courteouselk/Transactions/releases"><img src="https://img.shields.io/github/release/courteouselk/Transactions.svg" alt="GitHub release"></a>
<a href="https://github.com/Carthage/Carthage"><img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible"></a>
<a href="https://travis-ci.org/courteouselk/Transactions"><img src="https://travis-ci.org/courteouselk/Transactions.svg?branch=master" alt="Travis CI"></a>
<a href="https://codecov.io/gh/courteouselk/Transactions"><img src="https://codecov.io/gh/courteouselk/Transactions/branch/master/graph/badge.svg" alt="codecov"></a>
<a href="http://northernforest.nl/Transactions/"><img src="https://img.shields.io/badge/documentation-available-brightgreen.svg" alt="documentation"></a></p>

<p><a href="https://github.com/courteouselk/Transactions">Transactions</a> framework facilitates making atomic changes to the model:</p>

<ul>
<li>It provides a generic mechanism to <q>link</q> coherent hierarchies of objects that are supposed to change their state synchronously and atomically.</li>
<li>It defines call-back functions that are triggered on every object at every transaction start, pre-commit integrity check, commit, and rollback.</li>
<li>It provides convenience method to wrap transactional code in closures.  Such closures will be pre-pended by transaction start callbacks, post-pended by either commits or rollbacks, and will have an implicit integrity check ran for every member of the transaction context.</li>
</ul>

<p>This approach allows to encapsulate constraints checking and backup/restore operations within each individual class, thus placing related code together and making the whole logic clearer and easier to maintain.</p>

<p><strong>Example:</strong></p>

<p>Let&rsquo;s have a pie-chart object that will contain some elements that represent percentages of the chart area.  Total sum of the percentages must always be 100, each percentage must be greater than zero and not greater than 100.</p>

<p>Here is how the <code>PieChart</code> class could have been implemented:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Transactions</span>

<span class="kd">class</span> <span class="kt">PieChart</span> <span class="p">:</span> <span class="kt">Transactable</span>  <span class="p">{</span>

    <span class="kd">private</span> <span class="p">(</span><span class="k">set</span><span class="p">)</span> <span class="k">var</span> <span class="nv">elements</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">PieChartElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">elementsBackup</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">PieChartElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>

    <span class="c1">// Transaction context is a mediator class that "links" transaction</span>
    <span class="c1">// tree together.  There are two kinds of it, a root and a node.</span>
    <span class="k">var</span> <span class="nv">transactionContext</span><span class="p">:</span> <span class="kt">TransactionContext</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_transactionContext</span><span class="o">!</span> <span class="p">}</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_transactionContext</span><span class="p">:</span> <span class="kt">TransactionContext</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_transactionContext</span> <span class="o">=</span> <span class="kt">TransactionContext</span><span class="o">.</span><span class="nf">createRoot</span><span class="p">(</span><span class="nv">owner</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onBegin</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Back up of internal state is not needed because onCommit(), onRollback() and initialization</span>
        <span class="c1">// make it sure that backup is always up to date anyway.</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onValidateCommit</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">elements</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">+</span> <span class="nv">$1</span><span class="o">.</span><span class="n">percentage</span> <span class="p">})</span> <span class="o">==</span> <span class="mi">100</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">PieChartError</span><span class="o">.</span><span class="n">totalPercentageIsNot100</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onCommit</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">elementsBackup</span> <span class="o">=</span> <span class="n">elements</span> <span class="c1">// Overwrite the backup to release (potentially) deleted objects</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onRollback</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">elementsBackup</span> <span class="c1">// Restore the state from backup</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>

<span class="p">}</span>
</code></pre>

<p>.. the implementation of <code>onValidateCommit()</code> verifies that the chart is either empty, or has total sum of all percentages equal to exactly 100.</p>

<p>The implementation of <code>PieChartElement.onValidateCommit()</code> will check whether each individual percentage is within (0, 100] range:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">PieChartElement</span> <span class="p">:</span> <span class="kt">Transactable</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span>

    <span class="k">var</span> <span class="nv">percentage</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_percentage</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="nf">assert</span><span class="p">(</span><span class="n">transactionIsActive</span><span class="p">);</span> <span class="n">_percentage</span> <span class="o">=</span> <span class="n">newValue</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_percentage</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_percentageBackup</span><span class="p">:</span> <span class="kt">Int</span>

    <span class="k">var</span> <span class="nv">transactionContext</span><span class="p">:</span> <span class="kt">TransactionContext</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_transactionContext</span><span class="o">!</span> <span class="p">}</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_transactionContext</span><span class="p">:</span> <span class="kt">TransactionContext</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">chart</span><span class="p">:</span> <span class="kt">PieChart</span><span class="p">,</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">percentage</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_percentage</span> <span class="o">=</span> <span class="n">percentage</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_percentageBackup</span> <span class="o">=</span> <span class="n">percentage</span>
        <span class="n">_transactionContext</span> <span class="o">=</span> <span class="kt">TransactionContext</span><span class="o">.</span><span class="nf">createNode</span><span class="p">(</span><span class="nv">owner</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">parent</span><span class="p">:</span> <span class="n">chart</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onBegin</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onValidateCommit</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">_percentage</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">PieChartError</span><span class="o">.</span><span class="n">elementIsNotPositive</span>
        <span class="p">}</span>
        <span class="k">guard</span> <span class="n">_percentage</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">PieChartError</span><span class="o">.</span><span class="n">elementIsGreaterThan100</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onCommit</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_percentageBackup</span> <span class="o">=</span> <span class="n">_percentage</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onRollback</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_percentage</span> <span class="o">=</span> <span class="n">_percentageBackup</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>

<p>The rest of the example code (for the sake of completeness):</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">PieChartElement</span> <span class="p">:</span> <span class="kt">Transactable</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span>

    <span class="k">var</span> <span class="nv">percentage</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_percentage</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="nf">assert</span><span class="p">(</span><span class="n">transactionIsActive</span><span class="p">);</span> <span class="n">_percentage</span> <span class="o">=</span> <span class="n">newValue</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_percentage</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_percentageBackup</span><span class="p">:</span> <span class="kt">Int</span>

    <span class="k">var</span> <span class="nv">transactionContext</span><span class="p">:</span> <span class="kt">TransactionContext</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_transactionContext</span><span class="o">!</span> <span class="p">}</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_transactionContext</span><span class="p">:</span> <span class="kt">TransactionContext</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">chart</span><span class="p">:</span> <span class="kt">PieChart</span><span class="p">,</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">percentage</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_percentage</span> <span class="o">=</span> <span class="n">percentage</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_percentageBackup</span> <span class="o">=</span> <span class="n">percentage</span>
        <span class="n">_transactionContext</span> <span class="o">=</span> <span class="kt">TransactionContext</span><span class="o">.</span><span class="nf">createNode</span><span class="p">(</span><span class="nv">owner</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">parent</span><span class="p">:</span> <span class="n">chart</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onBegin</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onValidateCommit</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">_percentage</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">PieChartError</span><span class="o">.</span><span class="n">elementIsNotPositive</span>
        <span class="p">}</span>
        <span class="k">guard</span> <span class="n">_percentage</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">PieChartError</span><span class="o">.</span><span class="n">elementIsGreater100</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onCommit</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_percentageBackup</span> <span class="o">=</span> <span class="n">_percentage</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onRollback</span><span class="p">(</span><span class="nv">transaction</span><span class="p">:</span> <span class="kt">Transaction</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_percentage</span> <span class="o">=</span> <span class="n">_percentageBackup</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">PieChartError</span> <span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">elementIsNotPositive</span>
    <span class="k">case</span> <span class="n">elementIsGreaterThan100</span>
    <span class="k">case</span> <span class="n">totalPercentageIsNot100</span>
<span class="p">}</span>
</code></pre>

<p>Finally, the way it could have been used in Swift Playground:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">chart</span> <span class="o">=</span> <span class="kt">PieChart</span><span class="p">()</span>

<span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="n">chart</span><span class="o">.</span><span class="nf">transaction</span><span class="p">({</span>
        <span class="n">chart</span><span class="o">.</span><span class="nf">addElement</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"Part #1"</span><span class="p">,</span> <span class="nv">percentage</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span> <span class="c1">// Try to change 50 to 60</span>
        <span class="n">chart</span><span class="o">.</span><span class="nf">addElement</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"Part #2"</span><span class="p">,</span> <span class="nv">percentage</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">chart</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="nf">forEach</span><span class="p">({</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="nv">$0</span><span class="o">.</span><span class="n">label</span><span class="se">)</span><span class="s">, </span><span class="se">\(</span><span class="nv">$0</span><span class="o">.</span><span class="n">percentage</span><span class="se">)</span><span class="s">%"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>

<p>If you run the code above in a playground and change the percentages (make them too big, or negative, or not adding up to 100) then you will see that whenever any of the constraints is violated the transaction that made inconsistent changes is rolled back to the previous state (thus the model always remains consistent).</p>

<p>This makes it possible to simplify the way changes are applied to the model because you will be able to just change what has to be changed, and then if anything is wrong an expection will be thrown, so you can handle it, but still the data will stay consistent.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2017 <a class="link" href="" target="_blank" rel="external">Anton Bronnikov</a>. All rights reserved. (Last updated: 2017-05-29)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.8.2</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
